#!/bin/sh

sql=$(ssh root@idmy.team 'export CONF=/conf/prod_remote.conf && export PYTHONPATH=/var/www/idmy.team/:/var/www/idmy.team/settings/:$PYTHONPATH && python /var/www/idmy.team/helpers/dump_schema.py')
echo "$sql" > 'sql/schema.sql'

export CONF="/conf/test_local.conf"
export PYTHONPATH="$(pwd):$(pwd)/web:$(pwd)/settings:$(pwd)/helpers"
export PATH="$PATH:/usr/local/bin/"

python3 helpers/inline-css-email-templates.py > /dev/null 2>&1

black .

export CONF="/conf/test_local.conf"
export PYTHONPATH="$(pwd):$(pwd)/web:$(pwd)/settings:$(pwd)/helpers"
export PATH="$PATH:/usr/local/bin/"

/usr/local/bin/pytest

exit $?